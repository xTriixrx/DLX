name: Release Container

on:
  push:
    tags:
      - "v*"

permissions:
  contents: write
  packages: write
  id-token: write

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}

jobs:
  build-and-package:
    name: Build and Package (${{ matrix.arch }})
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        arch: [amd64, arm64]
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Normalize image name
        id: image
        run: |
          echo "name=${GITHUB_REPOSITORY,,}" >> "$GITHUB_OUTPUT"

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3

      - name: Set up Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to GHCR
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build and push image
        uses: docker/build-push-action@v6
        with:
          context: .
          push: true
          platforms: linux/${{ matrix.arch }}
          tags: |
            ${{ env.REGISTRY }}/${{ steps.image.outputs.name }}:${{ github.ref_name }}-${{ matrix.arch }}

      - name: Export image to tar
        run: |
          docker buildx build \
            --platform linux/${{ matrix.arch }} \
            --output type=docker,dest=dlx-${{ matrix.arch }}.tar \
            -t dlx:${{ github.ref_name }}-${{ matrix.arch }} \
            .

      - name: Compress image archive
        run: |
          tar -czf dlx-image-${{ github.ref_name }}-${{ matrix.arch }}.tar.gz dlx-${{ matrix.arch }}.tar
          rm -f dlx-${{ matrix.arch }}.tar

      - name: Install Syft
        uses: anchore/sbom-action/download-syft@v0

      - name: Generate SBOM (SPDX JSON)
        run: |
          syft docker-archive:dlx-image-${{ github.ref_name }}-${{ matrix.arch }}.tar.gz \
            -o spdx-json=dlx-image-${{ github.ref_name }}-${{ matrix.arch }}.sbom.json

      - name: Generate checksums
        run: |
          sha256sum \
            dlx-image-${{ github.ref_name }}-${{ matrix.arch }}.tar.gz \
            dlx-image-${{ github.ref_name }}-${{ matrix.arch }}.sbom.json \
            > dlx-image-${{ github.ref_name }}-${{ matrix.arch }}.sha256

      - name: Install Cosign
        uses: sigstore/cosign-installer@v3

      - name: Sign container image (keyless)
        env:
          COSIGN_EXPERIMENTAL: "1"
        run: |
          cosign sign --yes \
            ${{ env.REGISTRY }}/${{ steps.image.outputs.name }}:${{ github.ref_name }}-${{ matrix.arch }}

      - name: Sign artifacts (keyless)
        env:
          COSIGN_EXPERIMENTAL: "1"
        run: |
          cosign sign-blob --yes \
            --output-signature dlx-image-${{ github.ref_name }}-${{ matrix.arch }}.tar.gz.sig \
            --output-certificate dlx-image-${{ github.ref_name }}-${{ matrix.arch }}.tar.gz.crt \
            dlx-image-${{ github.ref_name }}-${{ matrix.arch }}.tar.gz
          cosign sign-blob --yes \
            --output-signature dlx-image-${{ github.ref_name }}-${{ matrix.arch }}.sbom.json.sig \
            --output-certificate dlx-image-${{ github.ref_name }}-${{ matrix.arch }}.sbom.json.crt \
            dlx-image-${{ github.ref_name }}-${{ matrix.arch }}.sbom.json

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: dlx-${{ github.ref_name }}-${{ matrix.arch }}
          path: |
            dlx-image-${{ github.ref_name }}-${{ matrix.arch }}.tar.gz
            dlx-image-${{ github.ref_name }}-${{ matrix.arch }}.sbom.json
            dlx-image-${{ github.ref_name }}-${{ matrix.arch }}.sha256
            dlx-image-${{ github.ref_name }}-${{ matrix.arch }}.tar.gz.sig
            dlx-image-${{ github.ref_name }}-${{ matrix.arch }}.tar.gz.crt
            dlx-image-${{ github.ref_name }}-${{ matrix.arch }}.sbom.json.sig
            dlx-image-${{ github.ref_name }}-${{ matrix.arch }}.sbom.json.crt

  release:
    name: Publish GitHub Release
    runs-on: ubuntu-latest
    needs: build-and-package
    steps:
      - name: Download artifacts
        uses: actions/download-artifact@v4
        with:
          path: release-assets

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ github.ref_name }}
          files: |
            release-assets/**/dlx-image-*.tar.gz
            release-assets/**/dlx-image-*.sbom.json
            release-assets/**/dlx-image-*.sha256
            release-assets/**/dlx-image-*.sig
            release-assets/**/dlx-image-*.crt
